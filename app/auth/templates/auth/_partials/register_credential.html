<!-- Modern styled credential registration card starts here --><div class="card p-6 sm:p-8 space-y-4 sm:space-y-6">
  <div class="flex items-center">
    <div class="bg-primary-100 text-primary-600 p-2 sm:p-3 rounded-lg mr-3 sm:mr-4">
      <i class="fas fa-key text-lg sm:text-xl"></i>
    </div>
    <div>
      <h3 class="text-lg sm:text-xl font-bold">Device Authentication</h3>
      <p class="text-sm sm:text-base text-gray-600">Set up this device for faster sign-in</p>
    </div>
  </div>    <div class="border-l-4 border-primary-400 bg-primary-50 p-3 sm:p-4 rounded-r-lg">
    <p class="text-sm sm:text-base text-gray-700">
      You currently have {{ current_user.credentials | length }} registered device(s). You can add additional authentication methods as backup options or for other devices you use. Each new registration creates a separate credential, even on the same device.
    </p>
  </div>    <button
    class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
    id="start-registration-{{ request.path | replace('/', '-') }}"
  >
    <i class="fas fa-fingerprint mr-2"></i>
    Add Additional Authentication Method
  </button>
</div>

<script>
    const startRegistrationButton = document.getElementById('start-registration-{{ request.path | replace('/', '-') }}');

    startRegistrationButton.addEventListener('click', async () => {
        // Show loading state
        const originalText = startRegistrationButton.innerHTML;
        startRegistrationButton.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Setting up...';
        startRegistrationButton.disabled = true;
      
        // Here we inject the options.
        const options = {{ public_credential_creation_options | safe }};

        try {
            const attResp = await startRegistration(options);
            
            // This route doesn't exist yet, we'll create it soon.
            const verificationResp = await fetch('{{ url_for("auth.add_credential") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(attResp)
            });
            const verificationJSON = await verificationResp.json();

            if (verificationJSON && verificationJSON.verified) {
                startRegistrationButton.innerHTML = '<i class="fas fa-check mr-2"></i> Setup Successful!';
                startRegistrationButton.classList.remove('bg-primary-600');
                startRegistrationButton.classList.add('bg-green-600');
                
                setTimeout(() => {
                    window.location.replace(verificationJSON.next);
                }, 1000);
            } else {
                throw new Error("Verification failed");
            }
        } catch (error) {
            console.error(error);
            startRegistrationButton.innerHTML = '<i class="fas fa-times mr-2"></i> Setup Failed';
            startRegistrationButton.classList.remove('bg-primary-600');
            startRegistrationButton.classList.add('bg-red-600');
            
            setTimeout(() => {
                startRegistrationButton.innerHTML = originalText;
                startRegistrationButton.disabled = false;
                startRegistrationButton.classList.remove('bg-red-600');
                startRegistrationButton.classList.add('bg-primary-600');
            }, 2000);
        }
    })
</script>